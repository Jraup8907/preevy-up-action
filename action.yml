name: "Preevy Up"
description: "Runs the Preevy `up` command"
author: "Livecycle"
branding:
  icon: box
  color: blue
inputs:
  profile-url:
    required: true
    description: "The Preevy profile URL"
  args:
    required: false
    description: "Additional args to provide to the `up` command."
  docker-compose-yaml-paths:
    required: false
    description: "Array of comma separated paths to docker compose files. Uses current working directory if not provided."
  version:
    required: false
    description: "Version of Preevy to use. Defaults to latest."
    default: latest
outputs:
  urls-json:
    description: "The generated URLs of the preview environments create by Preevy, formatted as a JSON object"
    value: ${{ steps.run_preevy.outputs.urls-json }}
  urls-file:
    description: "Path to file containing the generated URLs of the preview environments create by Preevy, formatted as a JSON object"
    value: ${{ steps.run_preevy.outputs.urls-file }}
runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: npm

    - name: Install the Preevy CLI
      shell: bash
      run: npm i -g preevy@${{ inputs.version }}

    - name: Initialize Preevy
      shell: bash
      run: preevy init --from ${{ inputs.profile-url }}

    - name: Run Preevy
      shell: bash
      id: run_preevy
      run: |
        file_opt=""
        if [[ ! -z "${{ inputs.docker-compose-yaml-paths }}" ]]; then
          file_opt="-f ${{ inputs.docker-compose-yaml-paths }}"
        fi

        urls_file=${RUNNER_TEMP}/preevy_urls.${RANDOM}.json

        preevy up ${file_opt} --output-urls-to ${urls_file} ${{ inputs.args }}

        cat ${urls_file}

        echo "urls-json=$(cat ${urls_file})" >> $GITHUB_OUTPUT
        echo "urls-file=${urls_file}" >> $GITHUB_OUTPUT
